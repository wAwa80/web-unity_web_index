<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>JJJJBET</title>
    <style>

        :root {
            --scale: 1;
        }

        body {
            padding: 0;
            margin: 0;
            background-color: black;
            overflow: hidden; /* Prevent scrollbars from appearing */
            /*width: 100%;
            height: 100%;*/
        }

        .iframe-home-img {
            z-index: 9000;
            display: block;
            position: absolute;
            top: 1%;
            left: 1%;
            background: transparent;
            width: 98px;
            height: 98px;
            cursor: pointer; /* Add mouse pointer style */
            background-image: url('./ui_an_lobby1.png'); /* Set image as background */
            background-size: cover; /* Ensure the image covers the button */
            background-position: center; /* Center the image */
            border: none; /* Remove button border */
        }

        .iframe-home-img-phone {
            z-index: 9000;
            display: block;
            position: absolute;
            top: 1%;
            left: 1%;
            background: transparent;
            width: 55px;
            height: 55px;
            cursor: pointer; /* Add mouse pointer style */
            background-image: url('./ui_an_lobby1.png'); /* Set image as background */
            background-size: cover;
            background-position: center;
            border: none;
            -webkit-tap-highlight-color: transparent; /* Disable tap highlight effect */
        }

        /* .button {
            position: absolute;
            width: 100px;
            height: 124px;
            background: transparent;
            border: 0;
            z-index: 9000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

            .button img {
                max-width: 50%;
                max-height: 50%;
            }*/

        #img-home-iframe, img-home-iframe-phone {
            top: 1%;
            left: 1%;
            display: none;
        }

        /* Remove default style when button is clicked */
        button:active, button:focus {
            outline: none; /* Remove outline when clicked */
            background-color: transparent; /* Only remove background color, not the background image */
            box-shadow: none; /* Remove shadow effect */
        }
    </style>


    <link rel="preload" href="./ui_an_lobby1.png" as="image">
</head>
<body>
    <button id="img-home-iframe" class="iframe-home-img">
    </button> 
    <button id="img-home-iframe-phone" class="iframe-home-img-phone">
    </button>


    <script>

        // PC button drag event
        function makeDraggable(element) {
            let offsetX = 0, offsetY = 0;
            let isDragging = false;
            let isClicking = false;    // Used to determine whether it's a click operation
            const safetyDistance = 10; // Safety distance in pixels

            element.addEventListener('mousedown', function (e) {
                if (e.button === 0) {  // Ensure it's the left mouse button
                    logger("mousedown");
                    offsetX = e.clientX - element.offsetLeft;
                    offsetY = e.clientY - element.offsetTop;
                    isClicking = true;  // Assume it's a click initially
                    isDragging = false;  // Reset dragging flag

                    // Disable the default click behavior
                    e.preventDefault();  // Prevent triggering other events

                    // Bind mousemove and mouseup events
                    document.addEventListener('mousemove', mouseMove);
                    document.addEventListener('mouseup', mouseUp);
                }
            });

            function mouseMove(e) {
                if (isClicking) {
                    logger("mouseMove isClicking");
                    let distanceX = Math.abs(e.clientX - offsetX - element.offsetLeft);
                    let distanceY = Math.abs(e.clientY - offsetY - element.offsetTop);

                    // If mouse moved past safety distance, start considering it a drag
                    if (distanceX > safetyDistance || distanceY > safetyDistance) {
                        isDragging = true;
                        isClicking = false;  // Cancel click event

                        element.style.position = 'absolute';  // Set to absolute positioning so the element can move freely
                        element.style.zIndex = 10000;  // Bring element to the front
                    }
                }

                if (isDragging) {
                    logger("mouseMove isDragging");

                    // Use requestAnimationFrame for smoother performance
                   
                        let x = e.clientX - offsetX;
                        let y = e.clientY - offsetY;

                        // Restrict dragging within the screen
                        //x = Math.max(0, Math.min(window.innerWidth - element.offsetWidth, x));
                        //y = Math.max(0, Math.min(window.innerHeight - element.offsetHeight, y));

                        element.style.left = `${x}px`;
                        element.style.top = `${y}px`;
                }
            }

            function mouseUp(e) {
                if (isDragging) {
                    logger("mouseUp isDragging");
                    let finalX = e.clientX - offsetX;
                    let finalY = e.clientY - offsetY;

                    finalX = Math.max(0, Math.min(window.innerWidth - element.offsetWidth, finalX));
                    finalY = Math.max(0, Math.min(window.innerHeight - element.offsetHeight, finalY));

                    element.style.left = `${finalX}px`;
                    element.style.top = `${finalY}px`;

                    element.style.zIndex = 10000;  // Restore z-index

                    isClicking = false;  // Prevent click after drag
                    isDragging = false;  // Reset dragging flag

                    // Remove mousemove and mouseup event listeners
                    document.removeEventListener('mousemove', mouseMove);
                    document.removeEventListener('mouseup', mouseUp);
                }
            }

            // Bind click event
            element.addEventListener('click', function () {
                if (isClicking) {
                    logger('Clicked!');
                    // Execute the click event
                    onBackHome();  // Execute the onBackHome function

                    isClicking = false;  // Prevent click after drag
                    isDragging = false;  // Reset dragging flag

                    // Bind mousemove and mouseup events
                    document.removeEventListener('mousemove', mouseMove);
                    document.removeEventListener('mouseup', mouseUp);
                }
            });

            // Bind mouseleave event
            element.addEventListener('mouseleave', function (e) {
                logger('mouseleave!');

                isClicking = false;  // Prevent click after drag
                isDragging = false;  // Reset dragging flag
                document.removeEventListener('mousemove', mouseMove);
                document.removeEventListener('mouseup', mouseUp);
            });
        }


        // Mobile button drag event
        function makeDraggableMobile(element) {
            let offsetX = 0, offsetY = 0, isDragging = false;
            let isClicking = false;  // Used to determine whether it's a click operation
            const safetyDistance = 10; // Safety distance in pixels
            let startX = 0, startY = 0; // Record the starting touch position

            // Listen for touchstart event
            element.addEventListener('touchstart', function (e) {
                if (e.touches.length === 1) {  // Ensure only one touch point
                    logger("touchstart");
                    //e.preventDefault();  // Prevent default behavior
                    isDragging = false;  // Initially not dragging
                    isClicking = true;  // Assume it's a click operation
                    const touch = e.touches[0];
                    startX = touch.clientX;
                    startY = touch.clientY;
                    offsetX = touch.clientX - element.getBoundingClientRect().left;
                    offsetY = touch.clientY - element.getBoundingClientRect().top;
                    element.style.zIndex = 10000;  // Raise z-index
                }
            });

            // Listen for touchmove event
            document.addEventListener('touchmove', function (e) {
                if (e.touches.length === 1) {  // Only handle single touch point
                    if (isClicking) {
                        const touch = e.touches[0];
                        const deltaX = touch.clientX - startX;
                        const deltaY = touch.clientY - startY;

                        // If the touch movement exceeds safety distance, start dragging
                        if (Math.abs(deltaX) > safetyDistance || Math.abs(deltaY) > safetyDistance) {
                            if (!isDragging) {
                                isDragging = true;
                                isClicking = false;  // Cancel click event
                            }
                        }
                    }

                    // Handle dragging
                    if (isDragging) {
                        logger("touchmove isDragging");
                        //e.preventDefault();  // Prevent scrolling
                        const touch = e.touches[0];
                        let x = touch.clientX - offsetX;
                        let y = touch.clientY - offsetY;

                        // Restrict dragging within the screen
                        x = Math.max(0, Math.min(window.innerWidth - element.clientWidth, x));
                        y = Math.max(0, Math.min(window.innerHeight - element.clientHeight, y));

                        element.style.left = x + 'px';
                        element.style.top = y + 'px';
                    }
                }
            }, { passive: false }); // Set passive: false to prevent error: Unable to preventDefault inside passive event listener due to target being treated as passive.

            // Listen for touchend event
            document.addEventListener('touchend', function () {
                if (isDragging) {
                    logger("touchend isDragging");
                    element.style.zIndex = 10000; // Restore z-index
                    isDragging = false;  // End dragging
                }
            });

            //// Listen for touchcancel event (sometimes touch events might be interrupted)
            //document.addEventListener('touchcancel', function () {
            //    if (isDragging) {
            //        logger("touchcancel isDragging");
            //        element.style.zIndex = 9000; // Restore z-index
            //        isDragging = false;  // End dragging
            //    }
            //});

            // Listen for click event (to prevent click during drag)
            element.addEventListener('click', function () {
                if (isClicking) {
                    logger('Clicked!');
                    // Execute click event
                    onBackHome();  // Execute the onBackHome function
                }
            });
        }


        if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
            // Show mobile-specific image, hide the desktop one
            document.getElementById("img-home-iframe-phone").style.display = "block";
            document.getElementById("img-home-iframe").style.display = "none";
            makeDraggableMobile(document.getElementById("img-home-iframe-phone"));
        } else {
            // Show desktop-specific image, hide the mobile one
            document.getElementById("img-home-iframe-phone").style.display = "none";
            document.getElementById("img-home-iframe").style.display = "block";
            makeDraggable(document.getElementById("img-home-iframe"));
        }

        function loadIframe(url) {
            // console.log("Loading iframe with URL:", url);
            loadIframeWithParams(url);
        }

        // Load iframe
        function loadIframeWithParams(url) {
            try {
              let iframeWeb = document.getElementById('myIframe');
              if (iframeWeb !== null) {
                iframeWeb.src = url; // 复用已存在的 iframe
                iframeWeb.style.display = 'block'; // 显示 iframe
                return;
              }

              // 创建新的 iframe
              let iframe = document.createElement('iframe');
              iframe.src = url;
              iframe.id = 'myIframe';
              iframe.width = '100%';
              iframe.style.border = 'none';
              iframe.style.position = 'absolute';
              iframe.style.top = '0';
              iframe.style.left = '0';
              iframe.style.height = `${document.documentElement.clientHeight}px`; // 设置初始高度
              iframe.style.backgroundColor = '#000000';
              iframe.style.zIndex = '1000'; // 设置在页面顶层

              // 调整高度事件监听器
              const resizeHandler = function () {
                iframe.style.height = `${document.documentElement.clientHeight}px`;
              };
              window.addEventListener('resize', resizeHandler);

              // 保存监听器引用，便于清理
              iframe._resizeHandler = resizeHandler;

              document.body.appendChild(iframe);
            } catch (error) {
              console.error('Error creating or appending iframe:', error);
            }
        }

        // Close iframe
        function closeIframe() {
            const iframe = document.getElementById('myIframe');
            if (!iframe) return;

            try {
                iframe.onload = null;
                iframe.onerror = null;

                // 设置 src 为空白页面，开始卸载 iframe 内容
                iframe.src = 'about:blank';

                // 跨域情况下无法访问 iframe 内容
                const doc = iframe.contentWindow?.document;
                if (doc) {
                    doc.open();
                    doc.write('');
                    doc.close();
                }
            } catch (e) {
                console.warn('跨域 iframe，跳过内容清除');
            }

            // 确保 iframe 的内容清空后再移除
            iframe.remove(); // 在加载完后移除
        }

        // Function to get query parameter by name
        function getQueryParam(name, url = window.location.search) {
            const urlParams = new URLSearchParams(url);
            return urlParams.get(name);
        }

        // Get homeUrl parameter
        let enterType = getQueryParam('enterType');
        let homeUrl = getQueryParam('homeUrl');
        let urlParam = getQueryParam('url');

        if(urlParam && urlParam != ''){
            loadIframe(urlParam);
        }

        window.addEventListener("message", function(event) {
            const { data } = event;
            
            // console.log('openIndex1 message ', data);

            if(data.comeFrom && data.comeFrom == 'hall'){
                let iframeWeb = document.getElementById('myIframe');
                if (iframeWeb) {
                    iframeWeb.contentWindow.postMessage(data, "*");
                }
            }

            if (data.message === 'openGame') {
                let _url = data.url
                enterType = getQueryParam('enterType', _url);
                homeUrl = getQueryParam('homeUrl', _url);
                if(!urlParam || urlParam == ''){
                    urlParam = _url
                    loadIframe(urlParam);
                }
            }
            else if (data.message === 'offline') {
                // console.log('openIndex1 offline data', data);
                showOfflinePopup(data.showText)
            }
            else if (data.message === 'closeOffline') {
                // console.log('close offline ');
                removeOfflinePopup();
            }
            else if (data.message === 'backToHome') {
                onBackHome();
            }
        });

        // Example of a return method, where you can execute onClick
        function onBackHome() {
            // console.log(" click back lobby button");
            

            let iframeWeb = document.getElementById('myIframe');
            // 通知 iframe 内部可能嵌套的子页面（如果 openIndex1.html 自己也是 iframe）
            if (iframeWeb && iframeWeb.contentWindow) {
                console.log("cleaar iframe memory postMessage onBackHome");                
                iframeWeb.contentWindow.postMessage({ message: 'onBackHome' }, '*');
            }

            setTimeout(()=>{
                if (enterType && enterType == 1) {
                    logger(" onBackHome :" + enterType + "  homeUrl: " + homeUrl);
                    window.open(homeUrl, '_self');
                }
                else {
                    const event = { message: 'returnHall' };
                    window.parent.postMessage(event, '*'); // '*' means allowing all sources
                    logger(" onBackHome  returnHall ");
                }
                urlParam = null

                closeIframe();

            }, 500)
        }

        function showOfflinePopup(showText) {
            // 检查是否已存在弹窗，避免重复创建
            if (document.getElementById('offline-popup-overlay')) return;
            
            showText = showText || "A conexão com a internet foi perdida,Por favor, tente novamente.";

            // 创建遮罩
            const overlay = document.createElement('div');
            overlay.id = 'offline-popup-overlay'; // 设置唯一 ID
            overlay.style.position = 'fixed';
            overlay.style.top = '0';
            overlay.style.left = '0';
            overlay.style.width = '100vw';
            overlay.style.height = '100vh';
            overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
            overlay.style.zIndex = '9999';
            overlay.style.display = 'flex';
            overlay.style.justifyContent = 'center';
            overlay.style.alignItems = 'center';
            document.body.appendChild(overlay);

            // 创建弹窗容器
            const popup = document.createElement('div');
            popup.style.position = 'relative';
            popup.style.width = '370px';
            popup.style.height = '160px';
            popup.style.borderStyle = 'solid';
            popup.style.borderWidth = '3px';
            popup.style.borderImage = 'url("./dg_dt_db2.png") 15 stretch';
            popup.style.backgroundColor = '#1b1b1b';
            popup.style.display = 'flex';
            popup.style.flexDirection = 'column';
            popup.style.alignItems = 'center';
            popup.style.padding = '15px';
            popup.style.borderRadius = '6px';
            overlay.appendChild(popup);

            // 添加标题
            const title = document.createElement('div');
            title.innerText = 'Lembrete';
            title.style.fontSize = '28px';
            title.style.color = '#C7C7C7';
            title.style.marginBottom = '8px';
            popup.appendChild(title);

            // 添加内容
            const content = document.createElement('div');
            content.innerText = showText
            content.style.fontSize = '14px';
            content.style.color = '#C7C7C7';
            content.style.lineHeight = '20px';
            content.style.width = '370px';
            content.style.textAlign = 'center';
            content.style.wordWrap = 'break-word';
            popup.appendChild(content);

            // 添加按钮
            const button = document.createElement('button');
            button.innerText = 'OK';
            button.style.width = '370px';
            button.style.height = '35px';
            button.style.marginTop = '12px';
            button.style.borderStyle = 'solid';
            button.style.borderWidth = '0px';
            button.style.borderImage = 'url("./dg_an_1_1.png") 10 stretch';
            button.style.color = '#000000';
            button.style.fontSize = '18px';
            button.style.border = 'none';
            button.style.borderRadius = '6px';
            button.style.cursor = 'pointer';
            button.style.backgroundColor = '#eebc52';
            button.onclick = () => {
                removeOfflinePopup();
                onBackHome();
            };
            popup.appendChild(button);
        }

        function removeOfflinePopup() {
            const overlay = document.getElementById('offline-popup-overlay');
            if (overlay) {
                overlay.remove();
            }
        }


        function logger(log) {
            if (false) {
                console.log(log);
            }
        }
        // test code : 
        //loadIframe("http://192.168.6.229:8079/?isEncrypt=true&member_account=sss001&member_password=qqq111&game_id=10102&game_guest=false&server_url=http%3A%2F%2F192.168.6.128:9001");
    </script>
</body>
</html>
